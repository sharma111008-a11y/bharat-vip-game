<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BHARAT VIP - SMART SESSION EDITION</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --gold: #efd36c; --dragon: #ff4d4d; --tiger: #4d94ff; --neon: #39ff14; --c10: #444; --c100: #1a5276; --c500: #7d3c98; --c1k: #1e8449; --c5k: #943126; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        body { background: #000; color: #fff; height: 100vh; overflow: hidden; background: radial-gradient(circle, #0a2e1a, #000); }
        #lobby { height: 100vh; display: flex; flex-direction: column; padding: 20px; }
        #gameUI { display: none; flex-direction: column; height: 100vh; }
        .top-nav { padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gold); }
        .history-bar { height: 40px; display: flex; align-items: center; gap: 6px; padding: 0 10px; overflow-x: auto; background: rgba(0,0,0,0.4); }
        .h-dot { min-width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }
        .table-container { flex: 1; display: flex; position: relative; }
        .side-players { width: 85px; display: flex; flex-direction: column; gap: 5px; padding: 10px 5px; background: rgba(0,0,0,0.2); }
        .p-box { background: rgba(255,255,255,0.08); border-radius: 4px; padding: 4px; font-size: 8px; text-align: center; border-left: 2px solid var(--neon); margin-bottom: 3px; }
        .p-box span { color: var(--gold); display: block; font-weight: bold; font-size: 10px; }
        .center-table { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #timer { position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; font-weight: 900; color: var(--neon); z-index: 10; text-shadow: 0 0 15px #000; }
        .card-row { display: flex; gap: 20px; margin-top: 10px; }
        .card { width: 68px; height: 95px; background: #fff; border-radius: 8px; color: #000; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 22px; }
        .card-back { background: linear-gradient(45deg, #800, #400); border: 2px solid #fff; }
        .tie-area { width: 90%; max-width: 320px; height: 55px; background: rgba(57, 255, 20, 0.1); border: 2.5px solid var(--neon); border-radius: 12px; margin: 10px auto; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .bet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; height: 140px; }
        .box { background: rgba(255,255,255,0.05); border: 1.5px solid #444; border-radius: 12px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .chip-bar { display: flex; justify-content: space-around; padding: 12px 5px; border-top: 2px solid var(--gold); }
        .c-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; border: 2px dashed rgba(255,255,255,0.3); }
        .c-btn.active { border-style: solid; border-color: var(--neon); box-shadow: 0 0 15px var(--neon); transform: scale(1.15); }
    </style>
</head>
<body>

<div id="lobby">
    <div style="background:rgba(0,0,0,0.8); border: 2px solid var(--gold); border-radius: 20px; padding: 15px; text-align: center; margin-bottom: 20px;">
        <div style="font-size:32px; color:var(--neon); font-weight:900;">₹<span id="l-bal">0</span></div>
    </div>
    <div onclick="enterGame('DT')" style="background:rgba(255,0,0,0.2); padding:25px; border-radius:15px; border:1px solid red; margin-bottom:15px; font-size:22px; font-weight:bold; text-align:center;">DRAGON TIGER</div>
    <div onclick="enterGame('AB')" style="background:rgba(212,175,55,0.2); padding:25px; border-radius:15px; border:1px solid var(--gold); font-size:22px; font-weight:bold; text-align:center;">ANDAR BAHAR</div>
</div>

<div id="gameUI">
    <div class="top-nav">
        <button onclick="location.reload()" style="background:#333; color:#fff; border:none; padding:5px 12px; border-radius:8px;">LOBBY</button>
        <div style="color:var(--gold); font-weight:bold;">BHARAT VIP</div>
        <div style="color:var(--neon); font-weight:bold;">₹<span id="g-bal">0</span></div>
    </div>
    <div class="history-bar" id="history-row"></div>
    <div class="table-container">
        <div class="side-players" id="left-players"></div>
        <div class="center-table">
            <div id="timer">15</div>
            <div id="j-box" style="display:none; text-align:center; margin-bottom:5px;"><div id="card-joker" class="card card-back"></div></div>
            <div class="card-row">
                <div style="text-align:center;"><p id="l-label" style="font-size:10px;"></p><div id="card-l" class="card card-back"></div></div>
                <div style="text-align:center;"><p id="r-label" style="font-size:10px;"></p><div id="card-r" class="card card-back"></div></div>
            </div>
            <div id="msg-box" style="margin-top:20px; font-weight:bold; color:var(--gold);">READY</div>
        </div>
        <div class="side-players" id="right-players"></div>
    </div>
    <div class="tie-area" id="mid-tie-box" onclick="placeBet('M')"><b>TIE</b><div id="cnt-m" style="color:var(--neon); font-weight:bold;">₹0</div></div>
    <div class="chip-bar">
        <div class="c-btn active" onclick="selC(10,this)" style="background:var(--c10)">10</div>
        <div class="c-btn" onclick="selC(100,this)" style="background:var(--c100)">100</div>
        <div class="c-btn" onclick="selC(500,this)" style="background:var(--c500)">500</div>
        <div class="c-btn" onclick="selC(1000,this)" style="background:var(--c1k)">1K</div>
        <div class="c-btn" onclick="selC(5000,this)" style="background:var(--c5k)">5K</div>
    </div>
    <div class="bet-grid">
        <div class="box" onclick="placeBet('L')"><div id="layer-L" style="position:absolute; inset:0;"></div><b id="btn-l"></b><div id="cnt-l" style="color:var(--gold); font-weight:bold;">₹0</div></div>
        <div class="box" onclick="placeBet('R')"><div id="layer-R" style="position:absolute; inset:0;"></div><b id="btn-r"></b><div id="cnt-r" style="color:var(--gold); font-weight:bold;">₹0</div></div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://bharat-vip-game-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let balance = 0, uid = localStorage.getItem('uID') || "VIP" + Math.floor(1000+Math.random()*9000);
    localStorage.setItem('uID', uid);
    let currentChip = 10, canBet = false, mode = "", pool = {L:0, M:0, R:0}, myBet = {L:0, M:0, R:0};

    // SESSION VARIABLES
    let sessionRounds = 0;
    let sessionTurnover = 0;
    let sessionPayout = 0;

    function syncUser() {
        db.ref('users/' + uid).on('value', snap => {
            let data = snap.val();
            if(!data) db.ref('users/' + uid).set({ wallet: 10000 });
            else balance = data.wallet || 0;
            document.getElementById('l-bal').innerText = balance.toLocaleString();
            document.getElementById('g-bal').innerText = balance.toLocaleString();
        });
    }

    function enterGame(m) {
        mode = m;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameUI').style.display = 'flex';
        document.getElementById('j-box').style.display = m==='AB' ? 'block' : 'none';
        document.getElementById('mid-tie-box').style.visibility = m==='DT' ? 'visible' : 'hidden';
        document.getElementById('l-label').innerText = m==='AB' ? 'ANDAR' : 'DRAGON';
        document.getElementById('r-label').innerText = m==='AB' ? 'BAHAR' : 'TIGER';
        document.getElementById('btn-l').innerText = m==='AB' ? 'ANDAR' : 'DRAGON';
        document.getElementById('btn-r').innerText = m==='AB' ? 'BAHAR' : 'TIGER';
        if(!window.loopActive) { startLoop(); window.loopActive=true; }
    }

    async function startLoop() {
        while(true) {
            resetTable();
            let jokerVal = -1;
            if(mode==='AB') {
                jokerVal = Math.floor(Math.random()*13);
                renderCard('card-joker', jokerVal, 0); await sleep(1000);
            }
            canBet=true; msg("PLACE YOUR BETS");
            let bots = setInterval(simulateLive, 250);
            for(let i=15; i>=0; i--) { document.getElementById('timer').innerText=i; await sleep(1000); }
            canBet=false; clearInterval(bots);
            msg("<span style='color:red'>STOP BETTING</span>"); await sleep(1500);

            // --- SMART SESSION LOGIC (20 ROUNDS) ---
            sessionRounds++;
            let totalRoundBet = pool.L + pool.R + pool.M;
            sessionTurnover += totalRoundBet;

            let lowSide = (pool.L <= pool.R) ? 'L' : 'R';
            let highSide = (pool.L > pool.R) ? 'L' : 'R';
            let currentProfitPercent = sessionTurnover > 0 ? ((sessionTurnover - sessionPayout) / sessionTurnover) * 100 : 10;
            
            let win = "";
            if(sessionRounds > 15 && currentProfitPercent < 5) win = lowSide;
            else if(sessionRounds > 15 && currentProfitPercent > 12) win = highSide;
            else win = (Math.random() < 0.7) ? lowSide : highSide;

            // Tie Chance (5%)
            if(Math.random() < 0.05) win = 'M';

            // Reset Session
            if(sessionRounds >= 20) { sessionRounds=0; sessionTurnover=0; sessionPayout=0; }

            // --- WIN EXECUTION ---
            if(mode==='AB') {
                let side = win === 'M' ? 'L' : win; // AB has no M, use logic
                let found = false;
                while(!found) {
                    let cv = Math.floor(Math.random()*13);
                    renderCard(side==='L'?'card-l':'card-r', cv, 0);
                    if(cv === jokerVal) { win = side; found = true; }
                    else { side = (side==='L'?'R':'L'); await sleep(800); }
                }
            } else {
                let v1, v2;
                if(win==='L') { v1=12; v2=2; } else if(win==='R') { v1=2; v2=12; } else if(win==='M') { v1=5; v2=5; }
                else { v1=Math.floor(Math.random()*13); v2=Math.floor(Math.random()*13); }
                renderCard('card-l', v1, 0); await sleep(800);
                renderCard('card-r', v2, 1);
            }
            
            // --- PAYOUT & TIE REFUND ---
            if(win === 'M') {
                if(myBet['M'] > 0) {
                    let w = myBet['M'] * 9; sessionPayout += w;
                    db.ref('users/'+uid+'/wallet').set(balance + w);
                }
                let refund = Math.floor((myBet['L'] + myBet['R']) * 0.5);
                if(refund > 0) {
                    sessionPayout += refund;
                    db.ref('users/'+uid+'/wallet').set(balance + refund);
                    msg("<span style='color:var(--neon)'>TIE: 50% REFUND!</span>");
                }
            } else {
                if(myBet[win] > 0) {
                    let w = Math.floor(myBet[win] * 1.98); sessionPayout += w;
                    db.ref('users/'+uid+'/wallet').set(balance + w);
                }
            }

            updateHistory(win);
            await sleep(4000);
        }
    }

    function simulateLive() {
        if(!canBet) return;
        let s = Math.random() > 0.6 ? 'L' : 'R';
        let v = [100, 500, 1000, 5000][Math.floor(Math.random()*4)];
        pool[s] += v;
        document.getElementById('cnt-'+s.toLowerCase()).innerText = "₹"+pool[s].toLocaleString();
        let sideDiv = s === 'L' ? 'left-players' : 'right-players';
        let container = document.getElementById(sideDiv);
        let rid = "VIP-" + Math.floor(100 + Math.random() * 899);
        container.innerHTML = `<div class="p-box">${rid}<span>₹${v}</span></div>` + container.innerHTML;
        if(container.children.length > 8) container.lastChild.remove();
    }

    function placeBet(s) {
        if(canBet && balance >= currentChip) {
            db.ref('users/'+uid+'/wallet').set(balance-currentChip);
            myBet[s]+=currentChip; pool[s]+=currentChip;
            document.getElementById('cnt-'+s.toLowerCase()).innerText = "₹"+pool[s].toLocaleString();
        }
    }

    function renderCard(id, v, s) {
        const vals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        let el = document.getElementById(id); el.classList.remove('card-back');
        el.innerHTML = `<div>${vals[v]}</div>`;
    }

    function updateHistory(w) {
        let row = document.getElementById('history-row');
        let d = document.createElement('div'); d.className = 'h-dot';
        d.style.background = w==='L' ? 'var(--dragon)' : (w==='R' ? 'var(--tiger)' : 'var(--neon)');
        d.innerText = mode==='AB' ? (w==='L'?'A':'B') : (w==='L'?'D':(w==='R'?'T':'Ti'));
        row.prepend(d);
        if(row.children.length > 15) row.lastChild.remove();
    }

    function resetTable() {
        document.querySelectorAll('.card').forEach(c=>{c.innerHTML=''; c.classList.add('card-back');});
        myBet={L:0, M:0, R:0}; pool={L:0, M:0, R:0};
        document.getElementById('cnt-l').innerText="₹0"; document.getElementById('cnt-r').innerText="₹0"; document.getElementById('cnt-m').innerText="₹0";
    }

    function selC(v, e) { currentChip=v; document.querySelectorAll('.c-btn').forEach(b=>b.classList.remove('active')); e.classList.add('active'); }
    function msg(t) { document.getElementById('msg-box').innerHTML = t; }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    syncUser();
</script>
</body>
</html>
